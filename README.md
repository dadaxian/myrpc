å€Ÿé‰´ï¼šhttps://github.com/Snailclimb/guide-rpc-framework

---------------------------------

# index

â”œâ”€`rpc-api`   rpcçš„æ¥å£   
â”œâ”€`rpc-client`  rpcå®¢æˆ·ç«¯  
â”œâ”€`rpc-server`   rpcæœåŠ¡ç«¯  
â”œâ”€`rpc-common`  æ ¸å¿ƒå®ç°  
â”‚--â””â”€src  
â”‚------â”œâ”€main  
â”‚------â”‚--â”œâ”€java  
â”‚------â”‚--â”‚--â””â”€pro  
â”‚------â”‚--â”‚------â””â”€gugg  
â”‚------â”‚--â”‚----------â”œâ”€base  
â”‚------â”‚--â”‚----------â”‚--â”œâ”€`extension`  æ‰©å±•ç±»åŠ è½½  
â”‚------â”‚--â”‚----------â”‚--â”œâ”€`factory`  å•ä¾‹å·¥å‚   
â”‚------â”‚--â”‚----------â”‚--â””â”€utils     
â”‚------â”‚--â”‚----------â”‚------â”œâ”€`concurrent`  çº¿ç¨‹æ±    
â”‚------â”‚--â”‚----------â”‚------â”‚--â””â”€`threadpool`   
â”‚------â”‚--â”‚----------â”‚------â””â”€`file`   æ–‡ä»¶è¯»å–   
â”‚------â”‚--â”‚----------â”œâ”€`common`   å·¥å…·å®ä½“ç±»  
â”‚------â”‚--â”‚----------â”œâ”€`config`   é…ç½®ï¼ˆæ¯”å¦‚ zkçš„åœ°å€ï¼‰  
â”‚------â”‚--â”‚----------â”œâ”€`hooks`   é’©å­ğŸ•  
â”‚------â”‚--â”‚----------â”œâ”€`remote`   è¿œç¨‹æ–¹æ³•ï¼ˆä¾‹å¦‚æœåŠ¡æ³¨å†Œ/å‘ç°ï¼‰  
â”‚------â”‚--â”‚----------â”œâ”€`rpcclient`    â­å®¢æˆ·ç«¯æ–¹æ³•  
â”‚------â”‚--â”‚----------â”‚--â”œâ”€`loadbalance`   è´Ÿè½½å‡è¡¡  
â”‚------â”‚--â”‚----------â”‚--â”œâ”€`proxy`   rpcæ¥å£ä»£ç†   
â”‚------â”‚--â”‚----------â”‚--â””â”€`socket`   è¿œç¨‹çš„socketå®ç°  
â”‚------â”‚--â”‚----------â””â”€`rpcserver`   â­æœåŠ¡ç«¯æ–¹æ³•  
â”‚------â”‚--â”‚--------------â”œâ”€`handler`  è¯·æ±‚å¤„ç†ï¼ˆåå°„æ‰§è¡Œï¼‰  
â”‚------â”‚--â”‚--------------â””â”€`provider`   æœåŠ¡æ²»ç†ï¼ˆæœåŠ¡çš„å‚¨å­˜/æ³¨å†Œï¼‰  
â”‚------â”‚--â””â”€resources   
â”‚------â”‚------â””â”€META-INF   
â””â”€-----â”‚----------â””â”€`extensions`   æ‰©å±•ç±»

# å¯åŠ¨ä¸é…ç½®

1. æ‰¾ä¸ªzookeeper å¯ä»¥è¿œç¨‹ ä¹Ÿå¯ä»¥æœ¬æœº
2. è¦ä¿®æ”¹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶propertiesä¸­çš„zkåœ°å€
3. é€ä¸ªå¯åŠ¨serverå’Œclientå³å¯

# æœåŠ¡ç«¯å®ç°

## ä¸»è¦æ–¹æ³•

æœåŠ¡ç«¯çš„è°ƒç”¨å®ç° é¦–å…ˆæœåŠ¡ç«¯è¦æ³¨å†Œé€šè¿‡ **_SocketRpcServer_** æ‰§è¡Œ æ³¨å†Œå’Œ socketçš„ç›‘å¬

1. å…³äºæ³¨å†Œ æ³¨å†Œé€šè¿‡ **_ServiceProvider_** ï¼ˆå•ä¾‹ï¼‰æ¥å®ç°
    * å…ˆå°† <æœåŠ¡çš„propertiesåºåˆ—åŒ–ç»“æœï¼Œè¦è°ƒç”¨çš„æ–¹æ³•æ‰€å±ç±»çš„å®ä¾‹>ï¼Œæ”¾å…¥æˆ‘ä»¬çš„mapä¸­
    * è°ƒç”¨Curatorå®ç°çš„zookeeperçš„å®¢æˆ·ç«¯å®ç°zookeeperçš„æœåŠ¡æ³¨å†Œã€‚

2. å…³äºç›‘å¬ ç›‘å¬é€šè¿‡tcp/udpå±‚é¢çš„socketæ¥ç›‘å¬ï¼ˆwhileæ­»å¾ªç¯ï¼‰ï¼Œå¯åŠ¨å‰æ‰§è¡Œé’©å­å‡½æ•°æ¸…é™¤æ‰€æœ‰çº¿ç¨‹æ± 
    * ä¸€æ—¦ç›‘å¬åˆ°ï¼Œå°±æ–°å»ºä¸€ä¸ªè‡ªå·±åˆ›å»ºçš„è‡ªå®šä¹‰çš„Runnableçº¿ç¨‹ï¼Œä¼ å…¥socketï¼Œå¹¶åœ¨çº¿ç¨‹ä¸­ä¼ å…¥RpcRequestHandlerï¼ˆå•ä¾‹ï¼‰
    * åœ¨å®ç°çš„runï¼ˆï¼‰ä¸­ï¼š åœ¨RpcRequestHandlerä¸­ï¼Œä½¿ç”¨åå°„å®Œæˆç»™å®šå¯¹è±¡å’Œæ–¹æ³•/å‚æ•°å¯¹æ–¹æ³•çš„è°ƒç”¨ã€‚

## æ³¨æ„ç‚¹

1. éœ€è¦æ³¨æ„çš„æ˜¯ ï¼Œè¿™é‡Œä½¿ç”¨äº†å•ä¾‹å·¥å‚çš„å†™æ³•ï¼Œè€Œä¸”å¾ˆå¤šåœ°æ–¹å†™çš„å•ä¾‹ä¸å®‰å…¨ã€‚
2. ç»Ÿä¸€çš„å‚æ•°æ²¡å†™å¥½ï¼Œæ¯”å¦‚socketæœ¬åœ°æš´éœ²çš„æ¥å£å®šä¹‰ä¸è§„èŒƒ
3. å¯¹å¤šçº¿ç¨‹çš„å¤„ç†ï¼Œæ˜¯å€¼å¾—å€Ÿé‰´çš„
4. å¯¹æ‰©å±•ç±»çš„å¤„ç†ï¼Œé‚£è¾¹çœ‹ä¸æ‡‚

# å®¢æˆ·ç«¯å®ç°

ä¸»è¦æ˜¯é€šè¿‡å†™æœåŠ¡å‘ç°ï¼Œåˆ°zookeeperä¸Šæ‰¾æœåŠ¡å<ç»„åï¼Œç‰ˆæœ¬å·ï¼Œæ–¹æ³•å>å¯¹åº”çš„æœåŠ¡åœ°å€<ip,port>, ç„¶åé€šè¿‡åŠ¨æ€ä»£ç†æ¥å£ç±»ï¼Œå®ç°åœ¨è°ƒç”¨æ¥å£åè¿œç¨‹è°ƒç”¨ï¼ˆsocket/nettyï¼‰æ¥è¿”å›æ•°æ®;

1. å…³äºæœåŠ¡å‘ç° å‘ç°æ˜¯é€šè¿‡å‘ç° **_ServiceRecovery_** æ¥å®ç°
    * é¦–å…ˆæ ¹æ®è°ƒç”¨çš„ç±»çš„ç±»åï¼Œç»„å ï¼Œç‰ˆæœ¬å· ç”Ÿæˆzookeeperçš„é”®å€¼ï¼Œ
    * ç„¶åè·å–å¯¹åº”çš„å­èŠ‚ç‚¹ï¼ˆä¸€å †socketä¸‰å…ƒç»„ï¼‰ï¼Œé€šè¿‡ä¸€è‡´æ€§hashç®—æ³•æˆ–è€…éšæœºç®—æ³•ï¼Œé€‰å–ä¸€ä¸ªä½œä¸ºç›®æ ‡åœ°å€
2. å…³äºè¿œç¨‹è°ƒç”¨ï¼Œä½¿ç”¨ **_RpcRequestTransport_** æ¥å£å¯¹åº”çš„å®ç°ç±»ï¼ˆsocket/nettyï¼Œå–å†³äºæœåŠ¡ç«¯çš„ç›‘å¬æ–¹å¼ï¼‰æ¥å‘é€requestï¼Œå¹¶è¿”å›

## æ³¨æ„ç‚¹

1. åœ¨æœåŠ¡å‘ç°æ—¶-> é€‰å–æœåŠ¡-> è´Ÿè½½å‡è¡¡â€”> ä¸€è‡´æ€§hash
2. è°ƒç”¨æœåŠ¡æ—¶ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†æœåŠ¡æ¥å£ç”Ÿæˆä»£ç†ç±»å®ç°è°ƒç”¨
3. éœ€è¦æ³¨æ„åºåˆ—åŒ–æ–¹å¼ï¼
4. å¯¹äº`ä¸€è‡´æ€§hash`(å«è™šæ‹ŸèŠ‚ç‚¹)çš„å®ç°  
```java
static class ConsistentHashSelector {
    // ä½¿ç”¨Treemapä½œä¸ºå“ˆå¸Œç¯çš„æ•°æ®ç»“æ„
    private final TreeMap<Long, String> virtualInvokers;
    private final int identityHashCode;
    ConsistentHashSelector(List<String> invokers, int replicaNumber, int identityHashCode) {
        this.virtualInvokers = new TreeMap<>();
        this.identityHashCode = identityHashCode;
        for (String invoker : invokers) {
            for (int i = 0; i < replicaNumber / 4; i++) {
                // æ¯å››ä¸ªä¸€ç»„è·å–æ‘˜è¦
               //æ ¹æ®md5ç®—æ³•ä¸ºæ¯4ä¸ªç»“ç‚¹ç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦ï¼Œæ‘˜è¦é•¿ä¸º16å­—èŠ‚128ä½ã€‚
                byte[] digest = md5(invoker + i);
                for (int h = 0; h < 4; h++) {
                    // è®¾ç½®4ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯¹æ‘˜è¦è¿›è¡Œhashè®¡ç®—
                   // éšåå°†128ä½åˆ†ä¸º4éƒ¨åˆ†ï¼Œ0-31,32-63,64-95,95-128ï¼Œ
                   // å¹¶ç”Ÿæˆ4ä¸ª32ä½æ•°ï¼Œå­˜äºlongä¸­ï¼Œlongçš„é«˜32ä½éƒ½ä¸º0
                    long m = hash(digest, h);
                    virtualInvokers.put(m, invoker);
                }
            }
        }
    }

    static long hash(byte[] digest, int idx) {
        return ((long) (digest[3 + idx * 4] & 255) << 24 | (long) (digest[2 + idx * 4] & 255) << 16 | (long) (digest[1 + idx * 4] & 255) << 8 | (long) (digest[idx * 4] & 255)) & 4294967295L;
    }

    public String select(String rpcServiceName) {
        byte[] digest = md5(rpcServiceName);
        return selectForKey(hash(digest, 0));
    }
    public String selectForKey(long hashCode) {
        Map.Entry<Long, String> entry = virtualInvokers.tailMap(hashCode, true).firstEntry();
        if (entry == null) {
            entry = virtualInvokers.firstEntry();
        }
        return entry.getValue();
    }
}
```